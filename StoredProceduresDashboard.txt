-- Scripts atualizados das procedures do dashboard
USE [CrepeControladorDb]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_ResumoPeriodo]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            0 AS QtdePedidos,
            CAST(0 AS DECIMAL(18, 2)) AS FaturamentoTotal,
            CAST(0 AS DECIMAL(18, 2)) AS TicketMedio,
            0 AS QtdeDiasPeriodo,
            CAST(0 AS DECIMAL(18, 2)) AS MediaClientesPorDia;
        RETURN;
    END

    DECLARE @DiasPeriodo INT = DATEDIFF(DAY, @Inicio, @Fim) + 1;

    ;WITH PedidosPeriodo AS
    (
        SELECT *
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado'
          AND CAST(DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
    )
    SELECT
        COUNT(*) AS QtdePedidos,
        ISNULL(SUM(ValorTotal), 0) AS FaturamentoTotal,
        CASE
            WHEN COUNT(*) = 0 THEN 0
            ELSE CAST(SUM(ValorTotal) / COUNT(*) AS DECIMAL(18, 2))
        END AS TicketMedio,
        @DiasPeriodo AS QtdeDiasPeriodo,
        CASE
            WHEN @DiasPeriodo = 0 THEN 0
            ELSE CAST(COUNT(*) AS DECIMAL(18, 2)) / @DiasPeriodo
        END AS MediaClientesPorDia
    FROM PedidosPeriodo;
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_ItensRanking]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT TOP 0
            i.Id AS ItemId,
            i.Nome,
            CAST(0 AS INT) AS QuantidadeVendida,
            CAST(0 AS DECIMAL(18, 2)) AS Faturamento
        FROM dbo.Itens i;
        RETURN;
    END

    SELECT
        i.Id AS ItemId,
        i.Nome,
        SUM(ip.Quantidade) AS QuantidadeVendida,
        SUM(ip.TotalItem) AS Faturamento
    FROM dbo.ItensPedidos ip
        INNER JOIN dbo.Pedidos p ON p.Id = ip.PedidoId
        INNER JOIN dbo.Itens i ON i.Id = ip.ItemId
    WHERE p.Status = 'Finalizado'
      AND CAST(p.DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
    GROUP BY i.Id, i.Nome
    ORDER BY QuantidadeVendida DESC, Faturamento DESC;
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_TipoPedido]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT TOP 0
            p.TipoPedido,
            0 AS QtdePedidos,
            CAST(0 AS DECIMAL(18, 2)) AS Faturamento
        FROM dbo.Pedidos p
        WHERE 1 = 0;
        RETURN;
    END

    SELECT
        p.TipoPedido,
        COUNT(*) AS QtdePedidos,
        SUM(p.ValorTotal) AS Faturamento
    FROM dbo.Pedidos p
    WHERE p.Status = 'Finalizado'
      AND CAST(p.DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
    GROUP BY p.TipoPedido;
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_HorariosPico_Periodo]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT CAST(NULL AS INT) AS Hora, CAST(0 AS INT) AS QuantidadePedidos, CAST(0 AS DECIMAL(18, 2)) AS Faturamento
        WHERE 1 = 0;
        RETURN;
    END

    SELECT
        DATEPART(HOUR, p.DataCriacao) AS Hora,
        COUNT(*) AS QuantidadePedidos,
        SUM(p.ValorTotal) AS Faturamento
    FROM dbo.Pedidos p
    WHERE p.Status = 'Finalizado'
      AND CAST(p.DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
    GROUP BY DATEPART(HOUR, p.DataCriacao)
    ORDER BY Hora;
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_HorariosPico_DiaSemanaResumo]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;
    SET DATEFIRST 1;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    DECLARE @DiasSemana TABLE (DiaSemana TINYINT PRIMARY KEY, NomeDia NVARCHAR(20));
    INSERT INTO @DiasSemana (DiaSemana, NomeDia)
    VALUES (1, N'Segunda'), (2, N'Terca'), (3, N'Quarta'), (4, N'Quinta'), (5, N'Sexta'), (6, N'Sabado'), (7, N'Domingo');

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            d.DiaSemana,
            d.NomeDia,
            0 AS Hora,
            0 AS QuantidadePedidos,
            CAST(0 AS DECIMAL(18, 2)) AS Faturamento
        FROM @DiasSemana d
        ORDER BY d.DiaSemana;
        RETURN;
    END

    ;WITH Base AS
    (
        SELECT
            DATEPART(WEEKDAY, p.DataCriacao) AS DiaSemana,
            DATEPART(HOUR, p.DataCriacao) AS Hora,
            COUNT(*) AS QuantidadePedidos,
            SUM(p.ValorTotal) AS Faturamento
        FROM dbo.Pedidos p
        WHERE p.Status = 'Finalizado'
          AND CAST(p.DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
        GROUP BY DATEPART(WEEKDAY, p.DataCriacao), DATEPART(HOUR, p.DataCriacao)
    )
    SELECT
        d.DiaSemana,
        d.NomeDia,
        ISNULL(r.Hora, 0) AS Hora,
        ISNULL(r.QuantidadePedidos, 0) AS QuantidadePedidos,
        ISNULL(r.Faturamento, 0) AS Faturamento
    FROM @DiasSemana d
    OUTER APPLY
    (
        SELECT TOP 1
            b.Hora,
            b.QuantidadePedidos,
            b.Faturamento
        FROM Base b
        WHERE b.DiaSemana = d.DiaSemana
        ORDER BY b.QuantidadePedidos DESC, b.Faturamento DESC, b.Hora
    ) r
    ORDER BY d.DiaSemana;
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_Dashboard_HorariosPico_DiaSemanaDistribuicao]
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;
    SET DATEFIRST 1;

    DECLARE @Inicio DATE = @DataInicio;
    DECLARE @Fim DATE = @DataFim;

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT
            @Inicio = COALESCE(@Inicio, MIN(CAST(DataCriacao AS DATE))),
            @Fim = COALESCE(@Fim, MAX(CAST(DataCriacao AS DATE)))
        FROM dbo.Pedidos
        WHERE Status = 'Finalizado';
    END

    IF (@Inicio IS NULL OR @Fim IS NULL)
    BEGIN
        SELECT CAST(NULL AS TINYINT) AS DiaSemana, CAST(NULL AS NVARCHAR(20)) AS NomeDia, CAST(NULL AS INT) AS Hora,
               CAST(0 AS INT) AS QuantidadePedidos, CAST(0 AS DECIMAL(18, 2)) AS Faturamento
        WHERE 1 = 0;
        RETURN;
    END

    DECLARE @DiasSemana TABLE (DiaSemana TINYINT PRIMARY KEY, NomeDia NVARCHAR(20));
    INSERT INTO @DiasSemana (DiaSemana, NomeDia)
    VALUES (1, N'Segunda'), (2, N'Terca'), (3, N'Quarta'), (4, N'Quinta'), (5, N'Sexta'), (6, N'Sabado'), (7, N'Domingo');

    SELECT
        b.DiaSemana,
        d.NomeDia,
        b.Hora,
        b.QuantidadePedidos,
        b.Faturamento
    FROM
    (
        SELECT
            DATEPART(WEEKDAY, p.DataCriacao) AS DiaSemana,
            DATEPART(HOUR, p.DataCriacao) AS Hora,
            COUNT(*) AS QuantidadePedidos,
            SUM(p.ValorTotal) AS Faturamento
        FROM dbo.Pedidos p
        WHERE p.Status = 'Finalizado'
          AND CAST(p.DataCriacao AS DATE) BETWEEN @Inicio AND @Fim
        GROUP BY DATEPART(WEEKDAY, p.DataCriacao), DATEPART(HOUR, p.DataCriacao)
    ) b
    INNER JOIN @DiasSemana d ON d.DiaSemana = b.DiaSemana
    ORDER BY b.DiaSemana, b.Hora;
END
GO
